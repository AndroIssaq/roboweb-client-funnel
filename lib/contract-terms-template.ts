/**
 * قالب شروط العقد القانونية
 * تم إعداده لضمان حقوق جميع الأطراف: العميل، الشركة، والشريك التسويقي
 */

export interface ContractParty {
  name: string
  idNumber: string
  phone: string
  email: string
  address?: string
}

export interface ContractDetails {
  contractNumber: string
  date: string
  client: ContractParty
  company: {
    name: string
    taxNumber: string
    commercialRegister: string
    address: string
    phone: string
    email: string
  }
  affiliate?: {
    name: string
    code: string
    commissionPercentage: number
    commissionAmount: number
  }
  service: {
    type: string
    packageName: string
    description: string
    deliverables: string[]
    timeline: string
  }
  payment: {
    totalAmount: number
    depositAmount: number
    remainingAmount: number
    paymentMethod: string
    paymentSchedule: string[]
  }
}

export function generateContractTerms(details: ContractDetails): string {
  const today = new Date().toLocaleDateString("ar-EG", {
    year: "numeric",
    month: "long",
    day: "numeric",
  })

  return `
# عقد تقديم خدمات تقنية

**رقم العقد:** ${details.contractNumber}  
**تاريخ التحرير:** ${today}

---

## أطراف العقد

### الطرف الأول (مقدم الخدمة):
**${details.company.name}**
- **السجل التجاري:** ${details.company.commercialRegister}
- **الرقم الضريبي:** ${details.company.taxNumber}
- **العنوان:** ${details.company.address}
- **الهاتف:** ${details.company.phone}
- **البريد الإلكتروني:** ${details.company.email}

### الطرف الثاني (العميل):
**${details.client.name}**
- **رقم الهوية/السجل:** ${details.client.idNumber}
- **الهاتف:** ${details.client.phone}
- **البريد الإلكتروني:** ${details.client.email}
${details.client.address ? `- **العنوان:** ${details.client.address}` : ""}

${
  details.affiliate
    ? `
### الطرف الثالث (الشريك التسويقي):
**${details.affiliate.name}**
- **كود الإحالة:** ${details.affiliate.code}
- **نسبة العمولة:** ${details.affiliate.commissionPercentage}%
- **مبلغ العمولة:** ${details.affiliate.commissionAmount.toLocaleString()} جنيه مصري
`
    : ""
}

---

## تمهيد

حيث أن الطرف الأول شركة متخصصة في تقديم الخدمات التقنية وتطوير البرمجيات، وحيث أن الطرف الثاني يرغب في الحصول على خدمات تقنية محددة، وحيث اتفق الطرفان على إبرام هذا العقد وفقاً للشروط والأحكام التالية:

---

## المادة الأولى: موضوع العقد

يتعهد الطرف الأول بتقديم الخدمات التالية للطرف الثاني:

### نوع الخدمة:
${details.service.type}

### الباقة المختارة:
${details.service.packageName}

### وصف الخدمة:
${details.service.description}

### المخرجات المتوقعة:
${details.service.deliverables.map((item, index) => `${index + 1}. ${item}`).join("\n")}

### المدة الزمنية:
${details.service.timeline}

---

## المادة الثانية: القيمة المالية وطريقة السداد

### إجمالي قيمة العقد:
**${details.payment.totalAmount.toLocaleString()} جنيه مصري** (${numberToArabicWords(details.payment.totalAmount)})

### الدفعة المقدمة:
**${details.payment.depositAmount.toLocaleString()} جنيه مصري** تُدفع عند التوقيع على العقد

### المبلغ المتبقي:
**${details.payment.remainingAmount.toLocaleString()} جنيه مصري** يُدفع وفقاً للجدول التالي:
${details.payment.paymentSchedule.map((item, index) => `${index + 1}. ${item}`).join("\n")}

### طريقة الدفع:
${details.payment.paymentMethod}

### شروط الدفع:
1. يجب تقديم إثبات دفع واضح (صورة من عملية التحويل) لكل دفعة
2. يتم التحقق من صحة إثبات الدفع خلال 24 ساعة عمل
3. لا يبدأ العمل إلا بعد التحقق من الدفعة المقدمة
4. في حالة التأخر عن السداد أكثر من 7 أيام، يحق للطرف الأول إيقاف العمل
5. جميع المبالغ غير قابلة للاسترداد بعد بدء العمل

---

## المادة الثالثة: التزامات الطرف الأول (مقدم الخدمة)

1. **الجودة:** تقديم الخدمة بأعلى معايير الجودة المهنية
2. **الوقت:** الالتزام بالمدة الزمنية المحددة ما لم تطرأ ظروف قاهرة
3. **التواصل:** إبقاء العميل على اطلاع دائم بتقدم العمل
4. **السرية:** الحفاظ على سرية جميع معلومات العميل
5. **الدعم الفني:** تقديم دعم فني لمدة شهر بعد التسليم (حسب الباقة)
6. **التسليم:** تسليم جميع المخرجات المتفق عليها كاملة
7. **التدريب:** تقديم تدريب أساسي على استخدام المنتج (إن وجد)
8. **الضمان:** ضمان عمل المنتج خالياً من الأخطاء البرمجية لمدة محددة

---

## المادة الرابعة: التزامات الطرف الثاني (العميل)

1. **السداد:** الالتزام بسداد المبالغ المستحقة في مواعيدها
2. **إثبات الدفع:** تقديم إثبات دفع واضح وصحيح لكل دفعة
3. **التعاون:** تقديم جميع المعلومات والمواد اللازمة للعمل
4. **المراجعة:** مراجعة العمل والرد على الاستفسارات خلال 3 أيام عمل
5. **الموافقات:** الموافقة على التصاميم والمراحل في الوقت المحدد
6. **عدم التعديل:** عدم طلب تعديلات جوهرية بعد الموافقة على المرحلة
7. **الاحترام:** التعامل باحترام مع فريق العمل
8. **البيانات الصحيحة:** تقديم بيانات هوية صحيحة وموثقة

---

## المادة الخامسة: حقوق الملكية الفكرية

1. **قبل السداد الكامل:** تظل جميع حقوق الملكية الفكرية للطرف الأول
2. **بعد السداد الكامل:** تنتقل حقوق الاستخدام للطرف الثاني مع احتفاظ الطرف الأول بحق عرض العمل في معرض أعماله
3. **الكود المصدري:** يتم تسليمه فقط في الباقات التي تشمل ذلك
4. **العلامة التجارية:** يحتفظ الطرف الأول بحق وضع علامته التجارية في المنتج
5. **إعادة البيع:** لا يحق للعميل إعادة بيع المنتج أو استخدامه تجارياً لصالح طرف ثالث

---

## المادة السادسة: التعديلات والإضافات

1. **التعديلات المجانية:** يحق للعميل طلب تعديلات محدودة حسب الباقة
2. **التعديلات الإضافية:** أي تعديلات خارج النطاق المتفق عليه تُحسب بتكلفة إضافية
3. **التعديلات الجوهرية:** تعديل جوهري في المشروع يتطلب عقد ملحق
4. **الموافقة المكتوبة:** جميع التعديلات تتم بموافقة مكتوبة من الطرفين

---

## المادة السابعة: التسليم والقبول

1. **التسليم الأولي:** يتم تسليم العمل للمراجعة
2. **فترة المراجعة:** 7 أيام عمل للمراجعة وطلب التعديلات
3. **التسليم النهائي:** بعد إجراء التعديلات المطلوبة
4. **القبول:** يُعتبر العمل مقبولاً بعد 7 أيام من التسليم النهائي دون اعتراض
5. **الاستلام:** توقيع محضر استلام نهائي

---

## المادة الثامنة: الإلغاء والفسخ

### من جانب العميل:
1. **قبل البدء:** استرداد 80% من المبلغ المدفوع
2. **بعد البدء:** لا يحق استرداد أي مبالغ
3. **أثناء التنفيذ:** دفع قيمة العمل المنجز + 30% من المتبقي

### من جانب مقدم الخدمة:
1. **عدم السداد:** إيقاف العمل بعد 7 أيام من التأخير
2. **إثبات دفع مزور:** إلغاء فوري مع اتخاذ إجراءات قانونية
3. **عدم التعاون:** بعد 3 إنذارات خطية

---

## المادة التاسعة: السرية وحماية البيانات

1. **التزام الطرفين:** بالحفاظ على سرية المعلومات
2. **عدم الإفشاء:** لأي طرف ثالث دون موافقة خطية
3. **البيانات الشخصية:** حمايتها وفقاً لقوانين حماية البيانات
4. **مدة السرية:** تستمر حتى بعد انتهاء العقد

---

## المادة العاشرة: الضمانات والمسؤولية

### ضمانات الطرف الأول:
1. خلو المنتج من الأخطاء البرمجية الجسيمة
2. توافق المنتج مع المواصفات المتفق عليها
3. عدم انتهاك حقوق ملكية فكرية لطرف ثالث

### حدود المسؤولية:
1. لا يتحمل الطرف الأول مسؤولية الأضرار غير المباشرة
2. الحد الأقصى للتعويض هو قيمة العقد
3. لا مسؤولية عن أخطاء ناتجة عن سوء استخدام العميل

---

## المادة الحادية عشرة: القوة القاهرة

1. لا يُسأل أي طرف عن التأخير الناتج عن قوة قاهرة
2. يجب إخطار الطرف الآخر خلال 48 ساعة
3. يتم تمديد المدة بما يعادل فترة القوة القاهرة

---

${
  details.affiliate
    ? `
## المادة الثانية عشرة: حقوق الشريك التسويقي

### التزامات الشركة تجاه الشريك:
1. **العمولة المستحقة:** ${details.affiliate.commissionAmount.toLocaleString()} جنيه (${details.affiliate.commissionPercentage}% من قيمة العقد)
2. **موعد الدفع:** خلال 7 أيام من تفعيل العقد وتحصيل الدفعة المقدمة
3. **إثبات الدفع:** تقديم إثبات دفع العمولة للشريك
4. **الشفافية:** إطلاع الشريك على حالة العقد

### شروط استحقاق العمولة:
1. تحقق عملية البيع بنجاح
2. سداد العميل للدفعة المقدمة
3. التحقق من صحة إثبات الدفع
4. عدم إلغاء العقد خلال 30 يوم

### حقوق الشريك:
1. الحصول على العمولة المتفق عليها
2. متابعة حالة العقد والعمولة
3. الحصول على إثبات دفع العمولة
4. الاعتراض في حالة عدم الدفع

### التزامات الشريك:
1. عدم تقديم وعود كاذبة للعميل
2. الترويج بشكل أخلاقي ومهني
3. عدم الإساءة لسمعة الشركة
4. الالتزام بسياسات الشركة التسويقية
`
    : ""
}

---

## المادة الأخيرة: أحكام ختامية

### التوقيعات والإثباتات:
1. **التوقيع الإلكتروني:** معتمد وله قوة قانونية
2. **صور الهوية:** مرفقة ومصدق عليها
3. **إثبات الدفع:** مرفق وموثق

### حل النزاعات:
1. **التفاوض:** محاولة حل النزاع ودياً خلال 15 يوم
2. **الوساطة:** اللجوء لوسيط محايد
3. **التحكيم:** اللجوء للتحكيم التجاري
4. **القضاء:** المحاكم المصرية هي المختصة

### اللغة والنسخ:
1. هذا العقد محرر باللغة العربية
2. تم إعداد نسختين، لكل طرف نسخة
3. جميع النسخ لها نفس القوة القانونية

### التعديلات:
1. لا يجوز تعديل العقد إلا بموافقة خطية من الطرفين
2. أي تعديل يكون بعقد ملحق موقع

### سريان العقد:
1. يسري من تاريخ التوقيع
2. ينتهي بتسليم العمل والسداد الكامل
3. تظل بعض البنود سارية بعد الانتهاء (السرية، الملكية الفكرية)

---

## إقرارات الأطراف

### إقرار الطرف الأول:
أقر أنا الموقع أدناه بالموافقة على جميع شروط وأحكام هذا العقد، وأتعهد بتنفيذ التزاماتي بحسن نية.

### إقرار الطرف الثاني:
أقر أنا الموقع أدناه بأنني:
1. قرأت جميع بنود العقد وفهمتها جيداً
2. أوافق على جميع الشروط والأحكام
3. قدمت بيانات هوية صحيحة
4. سأقدم إثبات دفع صحيح وواضح
5. أتعهد بالالتزام بجميع بنودي في العقد

${
  details.affiliate
    ? `
### إقرار الطرف الثالث (الشريك):
أقر أنا الموقع أدناه بأنني:
1. أفهم شروط استحقاق العمولة
2. أوافق على نسبة العمولة المحددة
3. التزمت بالترويج الأخلاقي للخدمة
4. لم أقدم وعود كاذبة للعميل
`
    : ""
}

---

## التوقيعات

### الطرف الأول (مقدم الخدمة):
- **الاسم:** ${details.company.name}
- **التوقيع الإلكتروني:** [سيتم إضافته]
- **التاريخ:** ${today}
- **صورة الهوية:** [مرفقة]

### الطرف الثاني (العميل):
- **الاسم:** ${details.client.name}
- **التوقيع الإلكتروني:** [سيتم إضافته]
- **التاريخ:** ${today}
- **صورة الهوية:** [مرفقة]
- **إثبات الدفع:** [مرفق]

${
  details.affiliate
    ? `
### الطرف الثالث (الشريك):
- **الاسم:** ${details.affiliate.name}
- **كود الإحالة:** ${details.affiliate.code}
- **التاريخ:** ${today}
`
    : ""
}

---

**تم إعداد هذا العقد إلكترونياً وهو ملزم قانوناً لجميع الأطراف**

**رقم العقد:** ${details.contractNumber}  
**تاريخ الإصدار:** ${today}  
**النظام:** Roboweb Client Funnel Management System

---

© ${new Date().getFullYear()} ${details.company.name} - جميع الحقوق محفوظة
`
}

function numberToArabicWords(num: number): string {
  // دالة بسيطة لتحويل الأرقام لكلمات عربية
  // يمكن تحسينها لاحقاً
  const ones = [
    "",
    "واحد",
    "اثنان",
    "ثلاثة",
    "أربعة",
    "خمسة",
    "ستة",
    "سبعة",
    "ثمانية",
    "تسعة",
  ]
  const tens = [
    "",
    "عشرة",
    "عشرون",
    "ثلاثون",
    "أربعون",
    "خمسون",
    "ستون",
    "سبعون",
    "ثمانون",
    "تسعون",
  ]
  const hundreds = [
    "",
    "مائة",
    "مائتان",
    "ثلاثمائة",
    "أربعمائة",
    "خمسمائة",
    "ستمائة",
    "سبعمائة",
    "ثمانمائة",
    "تسعمائة",
  ]

  if (num === 0) return "صفر"
  if (num < 10) return ones[num]
  if (num < 100) {
    const ten = Math.floor(num / 10)
    const one = num % 10
    return tens[ten] + (one > 0 ? " و" + ones[one] : "")
  }
  if (num < 1000) {
    const hundred = Math.floor(num / 100)
    const rest = num % 100
    return hundreds[hundred] + (rest > 0 ? " و" + numberToArabicWords(rest) : "")
  }
  if (num < 1000000) {
    const thousand = Math.floor(num / 1000)
    const rest = num % 1000
    return (
      numberToArabicWords(thousand) +
      " ألف" +
      (rest > 0 ? " و" + numberToArabicWords(rest) : "")
    )
  }

  return num.toLocaleString("ar-EG") // fallback للأرقام الكبيرة
}
