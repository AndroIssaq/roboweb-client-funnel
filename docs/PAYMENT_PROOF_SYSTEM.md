# نظام إثبات الدفع وحماية حقوق جميع الأطراف

## 📋 نظرة عامة

تم تطوير نظام متكامل لضمان حقوق جميع الأطراف في العقد:
- ✅ **حق العميل**: خدمة مضمونة بعقد قانوني ملزم
- ✅ **حق الشركة**: دفع مثبت وموثق قبل بدء العمل
- ✅ **حق الشريك**: عمولة مضمونة ومحسوبة تلقائياً

---

## 🗄️ التعديلات على قاعدة البيانات

### جدول `contracts` - حقول جديدة:

#### إثبات الدفع:
- `payment_proof_url` - رابط صورة إثبات الدفع
- `payment_proof_uploaded_at` - تاريخ الرفع
- `payment_proof_verified` - هل تم التحقق؟
- `payment_proof_verified_by` - المسؤول الذي تحقق
- `payment_proof_verified_at` - تاريخ التحقق
- `payment_proof_notes` - ملاحظات
- `payment_proof_method` - طريقة الدفع (InstaPay/Vodafone Cash/بنكي)

#### عمولة الشريك:
- `affiliate_commission_amount` - مبلغ العمولة
- `affiliate_commission_percentage` - نسبة العمولة
- `affiliate_commission_paid` - هل تم الدفع؟
- `affiliate_commission_paid_at` - تاريخ الدفع
- `affiliate_payment_proof_url` - إثبات دفع العمولة

#### حالات جديدة:
- `pending_payment_proof` - بانتظار رفع إثبات الدفع
- `pending_verification` - بانتظار التحقق من الدفع
- `suspended` - معلق لعدم الدفع

### جدول جديد: `payment_transactions`

سجل كامل لجميع المعاملات المالية:
- معلومات المعاملة (نوع، مبلغ، طريقة)
- إثبات الدفع
- حالة التحقق
- بيانات الدافع والمستلم
- ملاحظات

---

## 🔄 سير العمل (Workflow)

### 1. إنشاء العقد
```
العميل يوقع العقد
↓
حالة: pending_payment_proof
```

### 2. رفع إثبات الدفع
```
العميل يرفع صورة التحويل
↓
اختيار طريقة الدفع (InstaPay/Vodafone/بنكي)
↓
حالة: pending_verification
↓
إشعار فوري للمسؤولين
```

### 3. التحقق من الدفع
```
المسؤول يراجع الصورة
↓
يتحقق من: المبلغ، التاريخ، رقم العملية
↓
قرار: موافقة أو رفض
```

### 4. الموافقة
```
حالة: active
↓
تفعيل العقد
↓
حساب عمولة الشريك تلقائياً
↓
إشعارات للعميل والشريك
↓
بدء العمل
```

### 5. الرفض
```
حالة: pending_payment_proof
↓
إزالة الصورة المرفوضة
↓
إشعار للعميل مع السبب
↓
طلب رفع إثبات صحيح
```

---

## 🎨 المكونات (Components)

### للعميل:
**`PaymentProofUpload`**
- اختيار طريقة الدفع
- رفع صورة واضحة
- معاينة قبل الرفع
- إضافة ملاحظات
- تنبيهات قانونية

### للمسؤول:
**`PaymentProofVerification`**
- عرض معلومات العقد كاملة
- عرض الصورة بحجم كبير
- نقاط التحقق
- موافقة أو رفض مع ملاحظات
- حساب عمولة الشريك تلقائياً

---

## 🔌 API Endpoints

### `/api/upload-payment-proof` (POST)
رفع إثبات الدفع من العميل

**المدخلات:**
- `file` - صورة إثبات الدفع
- `contractId` - معرف العقد
- `paymentMethod` - طريقة الدفع
- `notes` - ملاحظات

**المخرجات:**
- رابط الصورة
- تحديث حالة العقد
- إنشاء سجل معاملة
- إشعار للمسؤولين

### `/api/verify-payment-proof` (POST)
التحقق من إثبات الدفع (مسؤولين فقط)

**المدخلات:**
- `contractId` - معرف العقد
- `action` - approve/reject
- `notes` - ملاحظات التحقق

**المخرجات:**
- تحديث حالة العقد
- تحديث حالة المعاملة
- حساب عمولة الشريك
- إشعارات لجميع الأطراف

---

## ⚖️ العقد القانوني

### `contract-terms-template.ts`

عقد شامل يحمي جميع الأطراف ويتضمن:

#### للعميل:
- ضمان الجودة والتسليم
- حقوق الملكية الفكرية
- شروط الإلغاء والاسترداد
- الدعم الفني والضمان
- حماية البيانات

#### للشركة:
- ضمان الدفع قبل البدء
- حقوق الملكية حتى السداد الكامل
- حق إيقاف العمل عند التأخير
- حق اتخاذ إجراءات قانونية
- حدود المسؤولية

#### للشريك:
- نسبة عمولة محددة
- موعد دفع واضح (7 أيام)
- إثبات دفع العمولة
- شروط استحقاق العمولة
- حق المتابعة والاعتراض

---

## 🔐 الأمان والحماية

### التحقق من الهوية:
- صور بطاقات الهوية لجميع الأطراف
- التوقيع الإلكتروني
- بيانات موثقة

### إثبات الدفع:
- صور واضحة للتحويلات
- التحقق اليدوي من المسؤول
- سجل كامل للمعاملات
- أرشفة جميع الإثباتات

### الحماية القانونية:
- عقد ملزم قانونياً
- بنود واضحة ومفصلة
- تنبيهات قانونية
- حل النزاعات بالتحكيم

---

## 🔔 نظام الإشعارات

### عند رفع إثبات الدفع:
- ✅ إشعار فوري للمسؤولين
- 📧 بريد إلكتروني (اختياري)

### عند الموافقة:
- ✅ إشعار للعميل بتفعيل العقد
- 💰 إشعار للشريك بتأكيد العمولة

### عند الرفض:
- ❌ إشعار للعميل مع السبب
- 📝 طلب رفع إثبات صحيح

---

## 📊 التقارير والإحصائيات

### View: `contract_payment_status`
عرض شامل لحالة الدفعات:
- إجمالي المبلغ
- المبلغ المدفوع
- المبلغ المتبقي
- حالة التحقق
- عمولة الشريك

---

## 🚀 كيفية الاستخدام

### 1. في صفحة العقد للعميل:
```tsx
import { PaymentProofUpload } from "@/components/contract/payment-proof-upload"

<PaymentProofUpload
  contractId={contract.id}
  contractNumber={contract.contract_number}
  depositAmount={contract.deposit_amount}
  onUploadComplete={() => router.refresh()}
/>
```

### 2. في لوحة المسؤول:
```tsx
import { PaymentProofVerification } from "@/components/admin/payment-proof-verification"

<PaymentProofVerification
  contractId={contract.id}
  contractNumber={contract.contract_number}
  paymentProofUrl={contract.payment_proof_url}
  paymentMethod={contract.payment_proof_method}
  depositAmount={contract.deposit_amount}
  uploadedAt={contract.payment_proof_uploaded_at}
  clientName={contract.client_name}
  affiliateName={contract.affiliate_name}
  affiliateCommission={contract.affiliate_commission_amount}
  onVerificationComplete={() => router.refresh()}
/>
```

### 3. في قالب العقد:
```tsx
import { generateContractTerms } from "@/lib/contract-terms-template"

const terms = generateContractTerms({
  contractNumber: "CON-2025-001",
  date: new Date().toISOString(),
  client: { /* بيانات العميل */ },
  company: { /* بيانات الشركة */ },
  affiliate: { /* بيانات الشريك */ },
  service: { /* تفاصيل الخدمة */ },
  payment: { /* تفاصيل الدفع */ }
})
```

---

## ✅ الفوائد

### للعميل:
- 🛡️ حماية قانونية كاملة
- 📄 عقد واضح ومفصل
- ⚖️ حقوق محفوظة
- 🎯 خدمة مضمونة

### للشركة:
- 💰 دفع مضمون قبل البدء
- 📸 إثبات موثق
- ⚡ تفعيل تلقائي بعد التحقق
- 🔒 حماية من الاحتيال

### للشريك:
- 💵 عمولة محسوبة تلقائياً
- 📊 متابعة شفافة
- ⏰ موعد دفع محدد
- 📜 إثبات دفع موثق

---

## 🎓 أفضل الممارسات

1. **التحقق السريع**: راجع إثبات الدفع خلال 24 ساعة
2. **التواصل الواضح**: اشرح سبب الرفض بوضوح
3. **الأرشفة**: احتفظ بجميع الإثباتات
4. **الشفافية**: أطلع جميع الأطراف على الحالة
5. **الاحترافية**: تعامل بمهنية مع جميع الأطراف

---

## 📝 ملاحظات مهمة

⚠️ **تنبيهات:**
- لا يبدأ العمل قبل التحقق من الدفع
- إثبات الدفع المزور جريمة قانونية
- جميع البيانات محفوظة ومؤرشفة
- العقد ملزم قانوناً لجميع الأطراف

✨ **مميزات:**
- نظام آلي بالكامل
- حساب تلقائي للعمولات
- إشعارات فورية
- سجل كامل للمعاملات

---

**تم التطوير بواسطة:** Roboweb Development Team  
**التاريخ:** 2025  
**الإصدار:** 1.0.0

© 2025 Roboweb - جميع الحقوق محفوظة
