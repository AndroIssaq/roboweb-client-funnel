# نظام حذف العقود

## ✅ ما تم إضافته:

### 1. **إشعارات عند إنشاء عقد من الشريك**
- ✅ إشعار Dashboard للأدمن
- ✅ بريد إلكتروني للأدمن
- ✅ يظهر في `/admin/notifications`

### 2. **نظام طلبات الحذف للشركاء**
- ✅ الشريك يطلب حذف العقد مع ذكر السبب
- ✅ يرسل إشعار للأدمن
- ✅ الأدمن يوافق أو يرفض
- ✅ إشعار للشريك بالقرار

### 3. **حذف مباشر للأدمن**
- ✅ الأدمن يقدر يحذف أي عقد مباشرة
- ✅ بدون طلب موافقة
- ✅ مع ذكر السبب

---

## 📋 الخطوات المطلوبة:

### 1. **طبق SQL**:
```sql
-- في Supabase SQL Editor
-- انسخ والصق: scripts/25-contract-deletion-requests.sql
-- اضغط Run
```

### 2. **أعد تشغيل السيرفر**:
```bash
npm run dev
```

---

## 🎯 كيف يعمل النظام:

### **للشريك**:
```
1. يفتح العقد: /affiliate/contracts/[id]
2. يضغط "طلب حذف العقد"
3. يكتب السبب (إجباري)
4. يرسل الطلب
5. ينتظر موافقة الأدمن
```

### **للأدمن**:
```
1. يستلم إشعار + بريد إلكتروني
2. يفتح: /admin/deletion-requests
3. يشوف تفاصيل الطلب
4. يوافق أو يرفض (مع ملاحظات)
5. الشريك يستلم إشعار بالقرار
```

### **حذف مباشر (أدمن)**:
```
1. يفتح العقد: /admin/contracts/[id]
2. يضغط "حذف العقد"
3. يكتب السبب
4. يحذف مباشرة (بدون موافقة)
```

---

## 📊 المميزات:

### **1. إشعارات كاملة**:
- ✅ Dashboard notifications
- ✅ Email notifications
- ✅ Real-time updates

### **2. Workflow محكم**:
- ✅ الشريك لا يقدر يحذف مباشرة
- ✅ لازم موافقة الأدمن
- ✅ الأدمن يقدر يحذف مباشرة

### **3. Audit Trail**:
- ✅ تسجيل كل الطلبات
- ✅ من طلب ومتى
- ✅ من راجع ومتى
- ✅ السبب والملاحظات

### **4. حماية**:
- ✅ RLS policies
- ✅ Role-based access
- ✅ لا يمكن حذف طلب تمت مراجعته

---

## 🔍 الصفحات الجديدة:

### **للشريك**:
- `/affiliate/contracts/[id]` - زر "طلب حذف العقد"

### **للأدمن**:
- `/admin/deletion-requests` - قائمة طلبات الحذف
- `/admin/contracts/[id]` - زر "حذف العقد" (مباشر)

---

## 🎨 UI Components:

### **DeleteContractButton** (للشريك):
- Dialog مع textarea للسبب
- Validation: السبب إجباري
- Loading state
- Toast notifications

### **DeletionRequestsList** (للأدمن):
- قائمة الطلبات المعلقة
- قائمة الطلبات المراجعة
- أزرار موافقة/رفض
- Dialog للمراجعة
- Badge للحالات

---

## 📧 الإشعارات:

### **عند إنشاء عقد من شريك**:
```
إلى: جميع الأدمن
العنوان: 🎉 عقد جديد من شريك
المحتوى: تفاصيل العقد والعميل
```

### **عند طلب حذف**:
```
إلى: جميع الأدمن
العنوان: ⚠️ طلب حذف عقد
المحتوى: تفاصيل العقد والسبب
```

### **عند الموافقة/الرفض**:
```
إلى: الشريك
العنوان: ✅/❌ قرار طلب الحذف
المحتوى: القرار والملاحظات
```

---

**طبق SQL وجرب! 🚀**
