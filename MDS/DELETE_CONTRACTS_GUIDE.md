# دليل حذف العقود

## ⚠️ مهم جداً: طبق SQL أولاً!

قبل أن تعمل أزرار الحذف، يجب تطبيق SQL:

```sql
-- في Supabase SQL Editor
-- انسخ والصق: scripts/26-fix-all-issues.sql
-- أو: scripts/25-contract-deletion-requests.sql
-- اضغط Run
```

---

## 🎯 كيف يعمل نظام الحذف:

### **للشريك (Affiliate)**:
```
1. يفتح العقد: /affiliate/contracts/[id]
2. يضغط "طلب حذف العقد" (زر أحمر في الأعلى)
3. يكتب السبب (إجباري)
4. يرسل الطلب
5. ينتظر موافقة الأدمن
```

**الحالات**:
- ✅ **زر "طلب حذف العقد"** - إذا لا يوجد طلب معلق
- ⏳ **زر "طلب حذف معلق"** - إذا يوجد طلب معلق (disabled)

---

### **للأدمن (Admin)**:

#### **طريقة 1: حذف مباشر**
```
1. يفتح العقد: /admin/contracts/[id]
2. يضغط "حذف العقد" (زر أحمر في الأعلى يمين)
3. يكتب السبب
4. يحذف مباشرة ✅
```

#### **طريقة 2: مراجعة طلبات الحذف**
```
1. يفتح: /admin/deletion-requests
2. يشوف قائمة الطلبات المعلقة
3. يضغط "الموافقة" أو "الرفض"
4. يكتب ملاحظات (اختياري للموافقة، إجباري للرفض)
5. يؤكد القرار
```

---

## 🔍 استكشاف الأخطاء:

### **المشكلة: الزر غير موجود**
```
✅ الحل: أعد تشغيل السيرفر
npm run dev
```

### **المشكلة: خطأ عند الضغط على الزر**
```
Error: relation "contract_deletion_requests" does not exist
```
**✅ الحل**: لم يتم تطبيق SQL بعد!
```sql
-- طبق: scripts/26-fix-all-issues.sql
```

### **المشكلة: "غير مصرح"**
```
✅ الحل: تأكد من role المستخدم
-- في Supabase SQL Editor:
SELECT id, email, role FROM users WHERE email = 'your@email.com';
-- يجب أن يكون role = 'admin' أو 'affiliate'
```

---

## 📍 مواقع الأزرار:

### **للشريك**:
```
/affiliate/contracts/[id]
↓
في الأعلى يمين (بجانب "العودة للعقود")
↓
زر أحمر: "طلب حذف العقد" 🗑️
```

### **للأدمن**:
```
/admin/contracts/[id]
↓
في الأعلى يسار (مقابل "العودة للعقود")
↓
زر أحمر: "حذف العقد" 🗑️
```

---

## 🎨 UI Components:

### **DeleteContractButton (للشريك)**:
```typescript
<DeleteContractButton
  contractId={contract.id}
  contractNumber={contract.contract_number}
  hasPendingRequest={deletionRequest?.status === "pending"}
/>
```

### **DeleteContractButton (للأدمن)**:
```typescript
<DeleteContractButton
  contractId={contract.id}
  contractNumber={contract.contract_number}
/>
```

---

## 📧 الإشعارات:

### **عند طلب حذف من شريك**:
```
📧 إلى: جميع الأدمن
📌 العنوان: ⚠️ طلب حذف عقد
💬 المحتوى: تفاصيل العقد والسبب
🔗 رابط: /admin/deletion-requests
```

### **عند موافقة الأدمن**:
```
📧 إلى: الشريك
📌 العنوان: ✅ تمت الموافقة على حذف العقد
💬 المحتوى: تم حذف العقد + ملاحظات
```

### **عند رفض الأدمن**:
```
📧 إلى: الشريك
📌 العنوان: ❌ تم رفض طلب حذف العقد
💬 المحتوى: سبب الرفض
```

### **عند حذف مباشر من الأدمن**:
```
📧 إلى: الشريك (إن وجد)
📌 العنوان: 🗑️ تم حذف عقد
💬 المحتوى: تم حذف العقد من قبل المسؤول + السبب
```

---

## ✅ التحقق من التثبيت:

### **1. تحقق من SQL**:
```sql
-- في Supabase SQL Editor
SELECT COUNT(*) FROM contract_deletion_requests;
-- يجب أن يعمل بدون خطأ ✅
```

### **2. تحقق من الأزرار**:
```
✅ افتح /affiliate/contracts/[id] - يجب أن ترى زر "طلب حذف العقد"
✅ افتح /admin/contracts/[id] - يجب أن ترى زر "حذف العقد"
✅ افتح /admin/deletion-requests - يجب أن تفتح الصفحة
```

### **3. اختبر الوظيفة**:
```
1. سجل دخول كشريك
2. افتح عقد
3. اضغط "طلب حذف العقد"
4. اكتب سبب
5. أرسل ✅

6. سجل دخول كأدمن
7. افتح /admin/deletion-requests
8. يجب أن ترى الطلب ✅
9. وافق أو ارفض ✅
```

---

## 🔐 الصلاحيات:

### **الشريك يقدر**:
- ✅ طلب حذف عقد (يحتاج موافقة)
- ❌ حذف مباشر (ممنوع)

### **الأدمن يقدر**:
- ✅ حذف أي عقد مباشرة (بدون موافقة)
- ✅ مراجعة طلبات الحذف
- ✅ الموافقة أو الرفض

---

**طبق SQL وجرب! 🚀**
