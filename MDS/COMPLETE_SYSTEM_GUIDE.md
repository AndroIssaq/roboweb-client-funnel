# 🎯 دليل النظام الكامل - الإشعارات والتوقيع الآمن

## ✅ ما تم إنجازه:

### **1. صفحة إشعارات للشريك** ✅
- `/affiliate/notifications` - صفحة كاملة للإشعارات
- Realtime updates باستخدام Supabase
- تحديد كمقروء / حذف
- أيقونات ملونة حسب نوع الإشعار

### **2. نظام Affiliate Tracking** ✅
- تتبع الزوار من رابط الشريك
- Cookie لمدة 30 يوم
- إشعار للشريك عند دخول زائر
- إشعار عند إنشاء عقد من الإحالة

### **3. نظام توقيع آمن** ✅
- الشريك يشوف التوقيعات فقط (read-only)
- لا يقدر يوقع مكان الأدمن أو العميل
- رسائل واضحة: "سيتم التوقيع من قبل..."

### **4. إشعارات Realtime** ✅
- إشعار للعميل عند إنشاء عقد
- إشعار للأدمن عند إنشاء عقد
- إشعار للشريك عند إنشاء عقد من إحالته
- إشعار للجميع عند اكتمال التوقيعات

### **5. Workflow التوقيع** ✅
```
1. الشريك/الأدمن ينشئ عقد
   ↓
2. إشعار للعميل + للأدمن + للشريك (إن وجد)
   ↓
3. الأدمن يوقع
   ↓
4. إشعار للعميل "جاهز للتوقيع"
   ↓
5. العميل يوقع
   ↓
6. تحويل تلقائي لـ PDF
   ↓
7. إشعار للجميع "العقد مكتمل" 🎉
```

### **6. زر تحميل PDF** ✅
- موجود في `ContractViewer`
- يعمل لجميع الأدوار (admin, client, affiliate)
- يظهر بعد التوقيعين

---

## 📁 الملفات الجديدة:

### **1. app/affiliate/notifications/page.tsx**
```typescript
// صفحة الإشعارات للشريك
export default async function AffiliateNotificationsPage()
```

### **2. components/affiliate/affiliate-notifications-list.tsx**
```typescript
// Component الإشعارات مع Realtime
export function AffiliateNotificationsList({ userId })
```

### **3. lib/actions/affiliate-tracking.ts**
```typescript
// تتبع الإحالات
export async function trackAffiliateReferral(affiliateCode)
export async function getAffiliateFromCookie()
export async function notifyAffiliateOnContractCreation(...)
```

---

## 🔄 الملفات المُحدثة:

### **1. components/contracts/contract-viewer.tsx**
- أضفت `userRole: "affiliate"` للـ interface
- أضفت رسائل read-only للشريك
- الشريك يشوف التوقيعات بس ما يقدر يوقع

### **2. lib/actions/contracts.ts**
- إشعار للعميل عند إنشاء عقد
- إشعار للشريك عند إنشاء عقد من إحالته
- Email للعميل مع رابط العقد

### **3. lib/actions/contract-workflow.ts**
- تحويل تلقائي لـ PDF بعد التوقيعين
- إشعار للشريك عند اكتمال العقد
- Revalidate paths للجميع

---

## 🎯 كيف يعمل النظام:

### **سيناريو 1: عميل يدخل من رابط شريك**
```
1. العميل يضغط على رابط: /signup?ref=ABC123
   ↓
2. trackAffiliateReferral("ABC123")
   ↓
3. Cookie يتحفظ لمدة 30 يوم
   ↓
4. إشعار للشريك: "🎯 زائر جديد من رابطك"
   ↓
5. لما العميل يعمل عقد:
   - إشعار للشريك: "🎉 عقد جديد من إحالتك!"
```

### **سيناريو 2: إنشاء عقد جديد**
```
الأدمن/الشريك ينشئ عقد
↓
إشعارات تُرسل:
├─ للعميل: "📄 عقد جديد بانتظار توقيعك"
├─ للأدمن: "عقد جديد تم إنشاؤه"
└─ للشريك (إن وجد): "🎉 عقد جديد من إحالتك!"

Emails تُرسل:
├─ للعميل: رابط العقد
└─ للشريك: تفاصيل العقد
```

### **سيناريو 3: التوقيع على العقد**
```
الأدمن يوقع
↓
إشعار للعميل: "عقدك جاهز للتوقيع"
↓
العميل يوقع
↓
تحويل تلقائي لـ PDF
↓
إشعارات للجميع:
├─ للأدمن: "🎉 عقد تم توقيعه بالكامل"
├─ للعميل: "تم التوقيع بنجاح"
└─ للشريك: "🎉 عقد مكتمل من إحالتك!"
```

---

## 🔐 الأمان:

### **الشريك**:
- ✅ يشوف العقد كامل
- ✅ يشوف التوقيعات
- ❌ لا يقدر يوقع
- ❌ لا يقدر يعدل

### **العميل**:
- ✅ يشوف عقده فقط
- ✅ يوقع عقده
- ❌ لا يقدر يشوف توقيع الأدمن قبل ما الأدمن يوقع

### **الأدمن**:
- ✅ يشوف كل العقود
- ✅ يوقع أي عقد
- ✅ يحذف أي عقد
- ✅ يراجع طلبات الحذف

---

## 📧 أنواع الإشعارات:

### **1. contract** (عقد)
- أيقونة: 📄 FileText (أزرق)
- مثال: "عقد جديد بانتظار توقيعك"

### **2. referral** (إحالة)
- أيقونة: 👥 UserPlus (أخضر)
- مثال: "زائر جديد من رابطك"

### **3. deletion** (حذف)
- أيقونة: ⚠️ AlertCircle (أحمر)
- مثال: "تم حذف عقد"

---

## 🚀 الخطوات المطلوبة:

### **1. تطبيق SQL**:
```sql
-- في Supabase SQL Editor
-- scripts/26-fix-all-issues.sql
```

### **2. إضافة متغيرات البيئة**:
```env
NEXT_PUBLIC_APP_URL=https://yourdomain.com
RESEND_API_KEY=re_xxxxx
RESEND_FROM_EMAIL=noreply@yourdomain.com
```

### **3. تفعيل Realtime في Supabase**:
```sql
-- في Supabase Dashboard → Database → Replication
-- فعّل Realtime للجدول: notifications
```

### **4. إعادة تشغيل السيرفر**:
```bash
npm run dev
```

---

## ✅ الاختبار:

### **1. اختبر صفحة الإشعارات**:
```
1. سجل دخول كشريك
2. افتح /affiliate/notifications
3. يجب أن تفتح الصفحة ✅
```

### **2. اختبر Affiliate Tracking**:
```
1. احصل على رابط الشريك
2. افتح في متصفح خاص: /signup?ref=CODE
3. سجل دخول كشريك
4. افتح /affiliate/notifications
5. يجب أن ترى إشعار "زائر جديد" ✅
```

### **3. اختبر التوقيع**:
```
1. أنشئ عقد جديد
2. سجل دخول كأدمن → وقع
3. سجل دخول كعميل → وقع
4. افتح العقد
5. يجب أن ترى "العقد مكتمل" ✅
6. اضغط "تحميل PDF" ✅
```

### **4. اختبر الإشعارات Realtime**:
```
1. افتح /affiliate/notifications في تاب
2. في تاب آخر: أنشئ عقد
3. ارجع للتاب الأول
4. يجب أن يظهر الإشعار تلقائياً ✅
```

---

## 🎨 UI Components:

### **صفحة الإشعارات**:
```
┌─────────────────────────────────────────┐
│ 🔔 الإشعارات                            │
│                                         │
│ [3 غير مقروء] [تحديد الكل كمقروء]      │
│                                         │
│ ┌─────────────────────────────────┐    │
│ │ 📄 عقد جديد بانتظار توقيعك      │    │
│ │ تم إنشاء عقد رقم RW-2024-001    │    │
│ │ [عرض] [✓] [🗑️]                  │    │
│ └─────────────────────────────────┘    │
│                                         │
│ ┌─────────────────────────────────┐    │
│ │ 👥 زائر جديد من رابطك           │    │
│ │ قام شخص بالدخول من رابطك        │    │
│ │ [عرض] [✓] [🗑️]                  │    │
│ └─────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

### **ContractViewer للشريك**:
```
┌─────────────────────────────────────────┐
│ توقيع Roboweb                           │
│ ┌─────────────────────────────────┐    │
│ │ [صورة التوقيع]                   │    │
│ │ ✓ تم التوقيع                     │    │
│ └─────────────────────────────────┘    │
│ [سيتم التوقيع من قبل المسؤول]          │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ توقيع العميل                            │
│ ┌─────────────────────────────────┐    │
│ │ ⏳ في انتظار التوقيع             │    │
│ └─────────────────────────────────┘    │
│ [سيتم التوقيع من قبل العميل]           │
└─────────────────────────────────────────┘
```

---

## 🔧 استكشاف الأخطاء:

### **المشكلة: الإشعارات لا تظهر**
```
✅ تحقق من SQL تم تطبيقه
✅ تحقق من Realtime مفعّل في Supabase
✅ تحقق من Console للأخطاء
```

### **المشكلة: Emails لا تُرسل**
```
✅ تحقق من RESEND_API_KEY
✅ تحقق من RESEND_FROM_EMAIL
✅ تحقق من Resend Dashboard للأخطاء
```

### **المشكلة: PDF لا يتحول**
```
✅ تحقق من التوقيعين موجودين
✅ تحقق من Console للأخطاء
✅ تحقق من lib/pdf/contract-template.ts
```

---

**النظام جاهز! 🚀**
